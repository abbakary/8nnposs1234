{% extends 'tracker/base.html' %}
{% load static %}
{% load humanize %}
{% load date_filters %}

{% block title %}Dashboard{% endblock %}
{% block extra_css %}
<style>
    /* Improved spacing and layout */
    .container-fluid {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
    
    /* Main KPI Cards - Compact and Attractive */
    .main-kpi-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        height: 100%;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    
    .main-kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    
    .main-kpi-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 1rem 1.25rem;
        border-radius: 12px 12px 0 0;
    }
    
    .main-kpi-header.performance {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    }
    
    .main-kpi-header.revenue {
        background: linear-gradient(135deg, #e74c3c 0%, #e67e22 100%);
    }
    
    .main-kpi-body {
        padding: 1.25rem;
        flex: 1;
    }
    
    /* Sub KPI Cards - Compact */
    .sub-kpi-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .sub-kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: linear-gradient(135deg, #3498db, #2c3e50);
    }
    
    .sub-kpi-card.performance::before {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
    }
    
    .sub-kpi-card.revenue::before {
        background: linear-gradient(135deg, #e74c3c, #e67e22);
    }
    
    .sub-kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    .sub-kpi-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1.2;
        margin-bottom: 0.25rem;
    }
    
    .sub-kpi-label {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0.5rem;
        line-height: 1.2;
    }
    
    .sub-kpi-trend {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.2rem 0.4rem;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
    }
    
    .trend-up {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    .trend-down {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .trend-neutral {
        background: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    /* Icon Styles - Smaller */
    .kpi-main-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    
    .sub-kpi-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }
    
    .bg-custom-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .bg-custom-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .bg-custom-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    .bg-custom-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
    .bg-custom-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }
    .bg-custom-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; }
    
    /* Chart improvements */
    .chart-container {
        position: relative;
        height: 250px;
    }
    
    .service-legend, .status-legend {
        margin-top: 0.75rem;
    }
    
    .legend-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.25rem;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin-bottom: 0.2rem;
    }
    
    /* Action button improvements */
    .dropdown-toggle::after {
        display: none;
    }
    
    .dropdown-menu {
        border: none;
        border-radius: 8px;
        min-width: 160px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .dropdown-item {
        padding: 6px 10px;
        font-size: 0.8rem;
        border-radius: 4px;
        margin: 2px 4px;
        width: auto;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #495057;
    }
    
    .dropdown-item i {
        width: 16px;
        text-align: center;
    }
    
    .btn-outline-primary.dropdown-toggle {
        border: 1px solid #dee2e6;
        background: white;
        color: #6c757d;
        padding: 3px 6px;
        font-size: 0.8rem;
        width: 32px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-outline-primary.dropdown-toggle:hover {
        background: #f8f9fa;
        border-color: #6c757d;
        color: #495057;
    }
    
    /* Table improvements */
    .table th {
        font-weight: 600;
        font-size: 0.85rem;
        color: #495057;
    }
    
    .table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    
    .avatar-initial {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    
    /* Card header improvements */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
    }
    
    .card-header h4, .card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .card-header .d-flex {
            margin-top: 0.5rem;
            width: 100%;
            justify-content: space-between;
        }
        
        .sub-kpi-value {
            font-size: 1.3rem;
        }
        
        .kpi-main-icon {
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
        }
        
        .main-kpi-body {
            padding: 1rem;
        }
        
        .main-kpi-header {
            padding: 0.75rem 1rem;
        }
    }
    
    /* Grid layout for sub KPIs */
    .sub-kpi-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        height: 100%;
    }

    @media (max-width: 992px) {
        .sub-kpi-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Revenue view toggle */
    .revenue-view-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .toggle-btn {
        flex: 1;
        padding: 0.5rem 1rem;
        border: 2px solid #e9ecef;
        background: white;
        color: #6c757d;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .toggle-btn:hover {
        border-color: #3498db;
        color: #3498db;
    }

    .toggle-btn.active {
        background: linear-gradient(135deg, #e74c3c 0%, #e67e22 100%);
        color: white;
        border-color: transparent;
    }

    .revenue-view {
        display: none;
    }

    .revenue-view.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h4>Service Centre - HQ Dashboard</h4>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'tracker:dashboard' %}">
                            <svg class="stroke-icon">
                                <use href="../assets/svg/icon-sprite.svg#stroke-home"></use>
                            </svg>
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main KPIs Section - Two Compact Cards -->
<div class="container-fluid mb-4">
    <div class="row g-3">
        <!-- Performance KPIs Card -->
        <div class="col-12">
            <div class="card main-kpi-card h-100">
               
                <div class="main-kpi-body">
                    <div class="sub-kpi-grid">
                        <!-- Total Customers -->
                        <div class="sub-kpi-card performance">
                            <div class="sub-kpi-icon bg-custom-1">
                                <i class="fa fa-users"></i>
                            </div>
                            <div class="sub-kpi-label">TOTAL CUSTOMERS</div>
                            <div class="sub-kpi-value">{{ total_customers|default:0|intcomma }}</div>
                            <div class="sub-kpi-trend trend-up">
                                <i class="fa fa-arrow-up"></i>
                                {{ new_customers_this_month|default:0 }} new this month
                            </div>
                        </div>

                        <!-- Total Orders -->
                        <div class="sub-kpi-card performance">
                            <div class="sub-kpi-icon bg-custom-2">
                                <i class="fa fa-shopping-bag"></i>
                            </div>
                            <div class="sub-kpi-label">TOTAL ORDERS</div>
                            <div class="sub-kpi-value">{{ total_orders|default:0|intcomma }}</div>
                            <div class="sub-kpi-trend {% if completion_rate >= 70 %}trend-up{% else %}trend-neutral{% endif %}">
                                <i class="fa fa-{% if completion_rate >= 70 %}check{% else %}minus{% endif %}"></i>
                                {{ completion_rate|floatformat:0 }}% complete
                            </div>
                        </div>

                        <!-- Completed Today -->
                        <div class="sub-kpi-card performance">
                            <div class="sub-kpi-icon bg-custom-3">
                                <i class="fa fa-check-circle"></i>
                            </div>
                            <div class="sub-kpi-label">COMPLETED TODAY</div>
                            <div class="sub-kpi-value">{{ completed_today|default:0 }}</div>
                            <div class="sub-kpi-trend trend-neutral">
                                <i class="fa fa-clock"></i>
                                as of {{ current_time|date:"H:i" }}
                            </div>
                        </div>

                        <!-- New Orders -->
                        <div class="sub-kpi-card performance">
                            <div class="sub-kpi-icon bg-custom-4">
                                <i class="fa fa-plus-circle"></i>
                            </div>
                            <div class="sub-kpi-label">NEW ORDERS TODAY</div>
                            <div class="sub-kpi-value">{{ new_orders_today|default:0 }}</div>
                            <div class="sub-kpi-trend trend-up">
                                <i class="fa fa-bolt"></i>
                                created today
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue KPIs Card -->
        <div class="col-12">
            <div class="card main-kpi-card h-100">
                <div class="main-kpi-body">
                    <!-- Revenue View Toggle -->
                    <div class="revenue-view-toggle">
                        <button type="button" class="toggle-btn active" data-view="all-time">
                            <i class="fa fa-history me-1"></i>All Time
                        </button>
                        <button type="button" class="toggle-btn" data-view="daily">
                            <i class="fa fa-calendar-day me-1"></i>Daily
                        </button>
                    </div>

                    <!-- All Time Revenue View -->
                    <div id="all-time-view" class="revenue-view active">
                        <div class="sub-kpi-grid">
                            <!-- Gross Revenue -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-success">
                                    <i class="fa fa-money-bill-wave"></i>
                                </div>
                                <div class="sub-kpi-label">GROSS REVENUE</div>
                                <div class="sub-kpi-value">{{ total_gross_revenue|default:0|floatformat:0|intcomma }} TSH</div>
                                <div class="sub-kpi-trend trend-up">
                                    <i class="fa fa-arrow-up"></i>
                                    All invoices total
                                </div>
                            </div>

                            <!-- Net Revenue -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-primary">
                                    <i class="fa fa-receipt"></i>
                                </div>
                                <div class="sub-kpi-label">NET REVENUE</div>
                                <div class="sub-kpi-value">{{ total_net_revenue|default:0|floatformat:0|intcomma }} TSH</div>
                                <div class="sub-kpi-trend trend-up">
                                    <i class="fa fa-arrow-up"></i>
                                    Subtotal value
                                </div>
                            </div>

                            <!-- VAT Total -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-info">
                                    <i class="fa fa-percent"></i>
                                </div>
                                <div class="sub-kpi-label">VAT TOTAL</div>
                                <div class="sub-kpi-value">{{ total_vat|default:0|floatformat:0|intcomma }} TSH</div>
                                <div class="sub-kpi-trend trend-up">
                                    <i class="fa fa-arrow-up"></i>
                                    Tax collected
                                </div>
                            </div>

                            <!-- Order Type Breakdown (compact) -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-warning">
                                    <i class="fa fa-chart-pie"></i>
                                </div>
                                <div class="sub-kpi-label">REVENUE BREAKDOWN</div>
                                <div style="font-size: 0.8rem; color: #333; margin: 0.5rem 0;">
                                    <div><strong>Sales:</strong> {{ revenue_by_type.sales|default:0|floatformat:0|intcomma }}</div>
                                    <div><strong>Service:</strong> {{ revenue_by_type.service|default:0|floatformat:0|intcomma }}</div>
                                    <div><strong>Labour:</strong> {{ revenue_by_type.labour|default:0|floatformat:0|intcomma }}</div>
                                </div>
                                <div class="sub-kpi-trend trend-neutral">
                                    <i class="fa fa-chart-bar"></i>
                                    By category
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Revenue View -->
                    <div id="daily-view" class="revenue-view">
                        <div class="sub-kpi-grid">
                            <!-- Daily Gross Revenue -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-success">
                                    <i class="fa fa-money-bill-wave"></i>
                                </div>
                                <div class="sub-kpi-label">GROSS REVENUE</div>
                                <div class="sub-kpi-value">{{ today_gross_revenue|default:0|floatformat:0|intcomma }} TSH</div>
                                <div class="sub-kpi-trend trend-up">
                                    <i class="fa fa-arrow-up"></i>
                                    Today's invoices
                                </div>
                            </div>

                            <!-- Daily Net Revenue -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-primary">
                                    <i class="fa fa-receipt"></i>
                                </div>
                                <div class="sub-kpi-label">NET REVENUE</div>
                                <div class="sub-kpi-value">{{ today_net_revenue|default:0|floatformat:0|intcomma }} TSH</div>
                                <div class="sub-kpi-trend trend-up">
                                    <i class="fa fa-arrow-up"></i>
                                    Subtotal value
                                </div>
                            </div>

                            <!-- Daily VAT Total -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-info">
                                    <i class="fa fa-percent"></i>
                                </div>
                                <div class="sub-kpi-label">VAT TOTAL</div>
                                <div class="sub-kpi-value">{{ today_vat|default:0|floatformat:0|intcomma }} TSH</div>
                                <div class="sub-kpi-trend trend-up">
                                    <i class="fa fa-arrow-up"></i>
                                    Tax collected
                                </div>
                            </div>

                            <!-- Daily Revenue Breakdown (compact) -->
                            <div class="sub-kpi-card revenue">
                                <div class="sub-kpi-icon bg-warning">
                                    <i class="fa fa-chart-pie"></i>
                                </div>
                                <div class="sub-kpi-label">REVENUE BREAKDOWN</div>
                                <div style="font-size: 0.8rem; color: #333; margin: 0.5rem 0;">
                                    <div><strong>Sales:</strong> {{ revenue_by_type_today.sales|default:0|floatformat:0|intcomma }}</div>
                                    <div><strong>Service:</strong> {{ revenue_by_type_today.service|default:0|floatformat:0|intcomma }}</div>
                                    <div><strong>Labour:</strong> {{ revenue_by_type_today.labour|default:0|floatformat:0|intcomma }}</div>
                                </div>
                                <div class="sub-kpi-trend trend-neutral">
                                    <i class="fa fa-chart-bar"></i>
                                    By category
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Revenue by Branch Section -->
<div class="container-fluid mb-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h6 class="card-title mb-3"><i class="fa fa-sitemap me-2"></i>Gross Revenue by Branch</h6>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead class="table-light">
            <tr>
              <th>Branch</th>
              <th class="text-end">Gross Revenue (TSH)</th>
            </tr>
          </thead>
          <tbody>
            {% for branch, amount in revenue_by_branch_tsh.items %}
                <tr>
                  <td>{{ branch }}</td>
                  <td class="text-end">{{ amount|floatformat:2|intcomma }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="2" class="text-center text-muted">No data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if user.is_superuser %}
<div class="container-fluid">
  <div class="card shadow-sm mb-3">
    <div class="card-body py-2">
      <div class="d-flex align-items-center">
        <button type="button" class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="collapse" data-bs-target="#adminBranchFilter" title="Toggle Admin Filters">
          <i class="fa fa-cog"></i>
        </button>
        <small class="text-muted">Admin Controls</small>
        {% if request.GET.branch %}
        <span class="badge bg-info text-dark ms-2">Branch {{ request.GET.branch }}</span>
        {% endif %}
      </div>
      <div class="collapse mt-2" id="adminBranchFilter">
        <form method="get" class="row g-2 align-items-end">
          <div class="col-auto">
            <label class="form-label fw-medium">Branch Filter</label>
            <input type="text" name="branch" value="{{ request.GET.branch }}" class="form-control" placeholder="Branch name" list="branchesList">
            {% include 'tracker/partials/branch_datalist.html' %}
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" type="submit"><i class="fa fa-filter me-1"></i>Apply Filter</button>
          </div>
          {% if request.GET.branch %}
          <div class="col-auto">
            <a href="?" class="btn btn-outline-secondary"><i class="fa fa-times me-1"></i>Clear</a>
          </div>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Rest of the content remains the same -->
<!-- Container-fluid starts -->
<div class="container-fluid">
    <!-- Second Row: Charts -->
    <div class="row g-3 mt-2">
        <!-- Service Distribution -->
        <div class="col-xxl-6 col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Service Distribution</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-calendar me-1"></i>Period
                        </button>
                        <ul class="dropdown-menu" id="servicePeriodMenu">
                            <li><a class="dropdown-item" href="#" data-period="week">This Week</a></li>
                            <li><a class="dropdown-item" href="#" data-period="month">This Month</a></li>
                            <li><a class="dropdown-item" href="#" data-period="quarter">This Quarter</a></li>
                            <li><a class="dropdown-item" href="#" data-period="year">This Year</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="serviceDistributionChart" width="400" height="300"></canvas>
                    </div>
                    <div class="service-legend">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #4e79a7;"></div>
                                    <small>Sales</small>
                                    <div class="fw-bold">{{ type_counts.sales|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #59a14f;"></div>
                                    <small>Service</small>
                                    <div class="fw-bold">{{ type_counts.service|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #f28e2b;"></div>
                                    <small>Inquiry</small>
                                    <div class="fw-bold">{{ type_counts.inquiry|default:0 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status -->
        <div class="col-xxl-6 col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>Order Status</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="orderStatusChart" width="400" height="300"></canvas>
                    </div>
                    <div class="status-legend mt-3">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #60a5fa;"></div>
                                    <small>New</small>
                                    <div class="fw-bold">{{ status_counts.new|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #f59e0b;"></div>
                                    <small>In Progress</small>
                                    <div class="fw-bold">{{ status_counts.in_progress|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #ef4444;"></div>
                                    <small>Overdue</small>
                                    <div class="fw-bold">{{ status_counts.overdue|default:0 }}</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #22c55e;"></div>
                                    <small>Completed</small>
                                    <div class="fw-bold">{{ status_counts.completed|default:0 }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Third Row: Top Customers -->
    <div class="row g-3 mt-2">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header card-no-border">
                    <h4>Top Customers by Orders</h4>
                    <div class="d-flex align-items-center gap-2">
                        <span class="update-data d-none d-md-block f-light">Top customers by order volume</span>
                        <a href="{% url 'tracker:customers_list' %}?sort=-order_count" class="ms-auto btn btn-outline-primary btn-sm">
                            View All <i class="fa fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-borderless">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">#</th>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Total Orders</th>
                                    <th>Last Order</th>
                                    <th>Registration Date</th>
                                    <th class="text-end pe-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in top_customers %}
                                <tr class="border-bottom">
                                    <td class="ps-4 fw-600">{{ forloop.counter }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2">
                                                <div class="avatar-initial bg-soft-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} rounded-circle d-flex align-items-center justify-content-center">
                                                    <span class="text-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} fw-600">
                                                        {{ customer.full_name|slice:":1"|upper }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="fw-600">{{ customer.full_name|default:'Unknown' }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            {% if customer.phone %}
                                            <a href="tel:{{ customer.phone }}" class="text-muted small">{{ customer.phone }}</a>
                                            {% endif %}
                                            {% if customer.email %}
                                            <a href="mailto:{{ customer.email }}" class="text-muted small text-truncate" style="max-width: 150px;" title="{{ customer.email }}">
                                                {{ customer.email }}
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="fw-600">{{ customer.order_count }} order{{ customer.order_count|pluralize }}</td>
                                    <td>
                                        {% if customer.latest_order_date %}
                                        <span class="fw-600">{{ customer.latest_order_date|date:"Y-m-d" }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="fw-600">{{ customer.registration_date|date:"Y-m-d" }}</span>
                                    </td>
                                    <td class="text-end pe-4">
                                        {% if customer.id %}
                                        <div class="dropdown">
                                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fa fa-ellipsis-h"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow">
                                                <li>
                                                    <a class="dropdown-item" href="{% url 'tracker:customer_detail' customer.id %}">
                                                        <i class="fa fa-eye text-primary me-2"></i>
                                                        View Details
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="{% url 'tracker:create_order_for_customer' customer.id %}">
                                                        <i class="fa fa-plus-circle text-success me-2"></i>
                                                        New Order
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item" href="tel:{{ customer.phone|default:'#' }}">
                                                        <i class="fa fa-phone text-info me-2"></i>
                                                        Call Customer
                                                    </a>
                                                </li>
                                                {% if customer.email %}
                                                <li>
                                                    <a class="dropdown-item" href="mailto:{{ customer.email }}">
                                                        <i class="fa fa-envelope text-warning me-2"></i>
                                                        Send Email
                                                    </a>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        {% else %}
                                        <span class="text-muted small">No actions</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="fa fa-users fa-2x text-muted mb-2"></i>
                                            <span class="text-muted">No customer data available</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fourth Row: Recent Orders -->
    <div class="row g-3 mt-2">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header card-no-border">
                    <h4>Recent Orders</h4>
                    <div class="d-flex align-items-center gap-2">
                        <span class="update-data d-none d-md-block f-light">Latest 10 orders</span>
                        <a href="{% url 'tracker:orders_list' %}" class="ms-auto btn btn-outline-primary btn-sm">
                            View All <i class="fa fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive custom-scrollbar" style="max-height: 400px;">
                        <table class="table table-hover table-borderless">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Order #</th>
                                    <th>Customer</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th class="text-end pe-4">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr class="border-bottom">
                                    <td class="ps-4">
                                        <a href="{% url 'tracker:order_detail' order.id %}" class="text-primary fw-600">#{{ order.order_number }}</a>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2">
                                                <div class="avatar-initial bg-soft-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} rounded-circle d-flex align-items-center justify-content-center">
                                                    <span class="text-{% cycle 'primary' 'success' 'warning' 'danger' 'info' %} fw-600">
                                                        {{ order.customer.full_name|default:'W'|slice:":1"|upper }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-600">{{ order.customer.full_name|default:'Walk-in Customer' }}</div>
                                                <div class="small text-muted">{{ order.customer.phone|default:'' }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-soft-{% if order.type == 'sales' %}primary{% elif order.type == 'service' %}success{% else %}secondary{% endif %} text-{% if order.type == 'sales' %}primary{% elif order.type == 'service' %}success{% else %}secondary{% endif %}">
                                            <i class="fa fa-{% if order.type == 'sales' %}shopping-cart{% elif order.type == 'service' %}tools{% else %}question-circle{% endif %} me-1"></i>
                                            {{ order.get_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-soft-{% if order.status == 'completed' %}success{% elif order.status == 'in_progress' %}warning{% elif order.status == 'created' %}info{% elif order.status == 'overdue' %}danger{% else %}secondary{% endif %} text-{% if order.status == 'completed' %}success{% elif order.status == 'in_progress' %}warning{% elif order.status == 'created' %}info{% elif order.status == 'overdue' %}danger{% else %}secondary{% endif %} p-2">
                                            <i class="fa fa-{% if order.status == 'completed' %}check-circle{% elif order.status == 'in_progress' %}spinner fa-spin{% elif order.status == 'created' %}clock{% elif order.status == 'overdue' %}exclamation-triangle{% else %}ellipsis-h{% endif %} me-1"></i>
                                            {{ order.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="d-flex flex-column">
                                            <span class="fw-600">{{ order.created_at|date:"Y-m-d H:i" }}</span>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="fa fa-inbox fa-2x text-muted mb-2"></i>
                                            <span class="text-muted">No recent orders found</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Container-fluid Ends -->
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    // Revenue View Toggle Functionality
    var toggleButtons = document.querySelectorAll('.toggle-btn');
    var allTimeView = document.getElementById('all-time-view');
    var dailyView = document.getElementById('daily-view');

    toggleButtons.forEach(function(button){
      button.addEventListener('click', function(){
        var view = this.getAttribute('data-view');

        // Remove active class from all buttons
        toggleButtons.forEach(function(btn){
          btn.classList.remove('active');
        });

        // Add active class to clicked button
        this.classList.add('active');

        // Hide all views
        allTimeView.classList.remove('active');
        dailyView.classList.remove('active');

        // Show selected view
        if(view === 'all-time'){
          allTimeView.classList.add('active');
        } else if(view === 'daily'){
          dailyView.classList.add('active');
        }
      });
    });

    // Progress bars init (existing)
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar){
      var width = bar.dataset.width;
      bar.style.width = width + '%';
      bar.setAttribute('aria-valuenow', width);
    });

    // Service Distribution Chart (Bar Chart)
    var serviceChart = null;
    try{
      var serviceCanvas = document.getElementById('serviceDistributionChart');
      if (serviceCanvas) {
        var ctx = serviceCanvas.getContext('2d');
        serviceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Sales', 'Service', 'Inquiry'],
            datasets: [{
              label: 'Current Period',
              data: [
                {{ type_counts.sales|default:0 }},
                {{ type_counts.service|default:0 }},
                {{ type_counts.inquiry|default:0 }}
              ],
              backgroundColor: [
                'rgba(78, 121, 167, 0.8)',
                'rgba(89, 161, 79, 0.8)',
                'rgba(242, 142, 43, 0.8)'
              ],
              borderColor: [
                'rgb(78, 121, 167)',
                'rgb(89, 161, 79)',
                'rgb(242, 142, 43)'
              ],
              borderWidth: 1,
              borderRadius: 6,
              barPercentage: 0.6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.y;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false
                },
                ticks: {
                  stepSize: 1
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // Period selection handling for Service Distribution
      (function(){
        var menu = document.getElementById('servicePeriodMenu');
        if(!menu) return;
        menu.addEventListener('click', function(e){
          var link = e.target.closest('.dropdown-item[data-period]');
          if(!link) return;
          e.preventDefault();
          var period = link.getAttribute('data-period');
          fetchAndUpdateServiceChart(period);
        });

        async function fetchAndUpdateServiceChart(period){
          try{
            var params = new URLSearchParams();
            if(period) params.set('period', period);
            var urlParams = new URLSearchParams(window.location.search);
            var branch = urlParams.get('branch');
            if(branch) params.set('branch', branch);
            var res = await fetch('/api/service-distribution/?' + params.toString(), { headers: { 'Accept': 'application/json' }});
            var json = await res.json();
            if(json && json.success && serviceChart){
              if(Array.isArray(json.values)){
                serviceChart.data.datasets[0].data = json.values;
              }
              if(json.label){
                serviceChart.data.datasets[0].label = json.label;
              }
              serviceChart.update();
            }
          }catch(err){
            console.error('Failed to update service distribution chart:', err);
          }
        }
      })();
    }catch(e){
      console.error('Error creating service distribution chart:', e);
    }

    // Order Status Chart using Chart.js with proper tooltips
    try{
      var statusCanvas = document.getElementById('orderStatusChart');
      if (statusCanvas) {
        var ctx = statusCanvas.getContext('2d');
        var statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['New', 'In Progress', 'Overdue', 'Completed', 'Cancelled'],
            datasets: [{
              data: [
                {{ status_counts.new|default:0 }},
                {{ status_counts.in_progress|default:0 }},
                {{ status_counts.overdue|default:0 }},
                {{ status_counts.completed|default:0 }},
                {{ status_counts.cancelled|default:0 }}
              ],
              backgroundColor: [
                '#60a5fa', // New - blue
                '#f59e0b', // In Progress - amber
                '#ef4444', // Overdue - red
                '#22c55e', // Completed - green
                '#94a3b8'  // Cancelled - gray
              ],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    var label = context.label || '';
                    var value = context.parsed || 0;
                    var total = context.dataset.data.reduce((a, b) => a + b, 0);
                    var percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    return label + ': ' + value + ' (' + percentage + '%)';
                  }
                }
              }
            },
            cutout: '55%'
          }
        });
      }
    }catch(e){
      console.error('Error creating order status chart:', e);
    }
  });
})();
</script>
{% endblock %}
